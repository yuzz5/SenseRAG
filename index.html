<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>多模态视频问答系统</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.7;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #1a66c3;
      font-size: 1.8em;
      margin-bottom: 10px;
    }

    .btn-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #1a66c3;
      color: white;
    }

    .btn-secondary {
      background-color: #e0e7ed;
      color: #1a66c3;
    }

    .search-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin: 20px 0;
      text-align: center;
    }

    .search-box h2 {
      color: #1a66c3;
      margin-top: 0;
      font-size: 1.4em;
    }

    .search-input {
      width: 80%;
      padding: 12px;
      border: 1px solid #d1dbe5;
      border-radius: 6px;
      font-size: 16px;
      margin: 10px 0;
      box-sizing: border-box;
    }

    .search-btn {
      background-color: #1a66c3;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-btn:hover {
      background-color: #134b8e;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin: 20px 0;
    }

    .section h2 {
      color: #1a66c3;
      margin-top: 0;
      padding-left: 10px;
      position: relative;
      border-left: 4px solid #1a66c3;
      font-size: 1.3em;
    }

    .result {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-top: 20px;
      display: none;
    }

    .loading {
      text-align: center;
      color: #1a66c3;
      display: none;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .images img {
      height: 120px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .answer {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #eee;
    }

    .sd-prompt {
      background-color: #f0f7ff;
      padding: 12px;
      border-left: 4px solid #1a66c3;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>SenseRAG: 多模态感知与生成式场景理解预测系统</h1>

  <div class="btn-group">
    <button class="btn btn-primary">PPT</button>
    <button class="btn btn-secondary">📄 文档</button>
    <button class="btn btn-secondary">📊 数据集</button>
  </div>

  <div class="search-box">
    <h2>多模态视频问答</h2>
    <p style="color: #666; text-align: center;">例如：“请帮我预测出视频ID为PBjKI8lrRws_1507的场景”</p>
    <input type="text" id="videoIdInput" class="search-input"
           placeholder="请输入包含视频ID的句子，如：视频ID是PBjKI8lrRws_1507" />
    <button class="search-btn" onclick="submitQuery()">🔍 提交查询</button>
  </div>

  <!-- 查询结果区域（紧接在搜索框下方） -->
  <div class="result" id="result">
    <h2>视频 ID: <span id="resVideoId"></span> （标签：<span id="resLabel"></span>）</h2>
    <div class="images" id="originalFrameDiv"></div>
    <div class="images" id="sdImagesDiv"></div>
    <div id="answers"></div>
    <h3>Stable Diffusion Prompt</h3>
    <div class="sd-prompt" id="sdPrompt"></div>
  </div>

  <div class="loading" id="loading">正在加载...</div>
  <div class="error" id="error"></div>

  <!-- 项目介绍部分（保持在结果下方） -->
  <div class="section">
    <h2>一、项目方向与核心目标</h2>
    <p>SenseRAG旨在构建一个融合视听感知、检索增强生成（RAG）、大语言模型与扩散生成模型的场景理解预测系统。该系统通过视听问答（AVQA）框架，将多模态感知与自然语言推理深度结合，实现从感知到预测可视化的完整闭环。</p>
    <p>在研究层面，系统将重点突破以下方向：建立视听信号的高效对齐与语义编码机制；引入检索增强策略提升推理能力；研发事故预测与后果推演机制；利用Stable Diffusion等扩散模型实现预测结果的可视化呈现。</p>
    <p>在预期成果方面，SenseRAG将在三个层面创造价值：科学层面推动AVQA与多模态RAG技术的发展，探索"感知-检索-生成"一体化范式；技术层面以国际基准（如AVQA数据集、nuScenes/Argoverse）为评测平台，确保在多模态问答准确率、预测精度等指标上达到先进水平；社会层面直接对接《人工智能+行动意见》、《数字中国建设2025年行动方案》等国家战略需求。</p>
    <p>SenseRAG的研发不仅是对人工智能前沿的探索，更是落实国家战略的具体实践，为推动人工智能实现安全可控、解释透明提供了新的技术路径。</p>
  </div>

  <div class="section">
    <h2>二、原理简介</h2>
    <p>本系统通过一个连贯的流程实现视频理解与预测。首先，在数据准备阶段，系统利用Vggish和VGG-19分别处理音频与视频帧，并借助CLIP模型将文本标签与视频帧统一编码为512维向量，存入向量数据库以构建一个多模态信息库。</p>
    <p>当用户提问时，系统会对查询进行分解，并将其编码为向量用于检索，同时保留原始文本作为上下文。随后，该向量在数据库中进行相似性搜索，找出最相关的关键视频帧，并将其与原始问题一同提交给大型语言模型。MLLM综合这些信息后，生成包含文本答案、时间戳和证据帧的回应。</p>
    <p>对于预测性任务，系统会检索原视频的最后一帧，并将MLLM生成的预测答案作为提示词，共同输入至Stable Diffusion模型。最终，模型基于这些条件合成符合逻辑的预测图像，从而完成从理解现状到生成未来的跨越。</p>
  </div>
</div>

<script>
  // 从自然语言中提取 video_id 的函数
  function extractVideoId(input) {
    // 匹配格式：字母数字组合 + _ + 数字，如 PBjKI8lrRws_1507
    const match = input.match(/[A-Za-z0-9]+_[0-9]+/);
    return match ? match[0] : null;
  }

  async function submitQuery() {
    const rawInput = document.getElementById('videoIdInput').value.trim();
    if (!rawInput) {
      alert('请输入包含视频ID的句子');
      return;
    }

    // ✅ 关键：从句子中提取 video_id
    const videoId = extractVideoId(rawInput);
    if (!videoId) {
      document.getElementById('error').textContent = '❌ 未检测到有效的视频ID（格式如：PBjKI8lrRws_1507）';
      document.getElementById('error').style.display = 'block';
      return;
    }

    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    loading.style.display = 'block';
    errorEl.style.display = 'none';
    resultEl.style.display = 'none';

    try {
      const res = await fetch(`/api/result?video_id=${encodeURIComponent(videoId)}`);
      const data = await res.json();

      if (res.status !== 200) {
        throw new Error(data.error || '未知错误');
      }

      document.getElementById('resVideoId').textContent = data.video_id;
      document.getElementById('resLabel').textContent = data.label;

      const origDiv = document.getElementById('originalFrameDiv');
      origDiv.innerHTML = data.original_frame_url ?
        `<strong>原始最后一帧：</strong><br><img src="${data.original_frame_url}" alt="original frame">` : '';

      const sdImagesDiv = document.getElementById('sdImagesDiv');
      if (data.sd_image_urls && data.sd_image_urls.length > 0) {
        let sdImagesHtml = '<strong>Stable Diffusion 生成图像：</strong><br>';
        data.sd_image_urls.forEach(url => {
          sdImagesHtml += `<img src="${url}" alt="SD image" style="height:120px; margin:5px; border:1px solid #ddd; border-radius:4px;">`;
        });
        sdImagesDiv.innerHTML = sdImagesHtml;
      } else {
        sdImagesDiv.innerHTML = '<strong>未找到生成图像</strong>';
      }

      const answersDiv = document.getElementById('answers');
      answersDiv.innerHTML = '';
      data.answers.forEach(a => {
        const div = document.createElement('div');
        div.className = 'answer';
        div.innerHTML = `<strong>${a.question}</strong><br>${a.answer}`;
        answersDiv.appendChild(div);
      });

      document.getElementById('sdPrompt').textContent = data.sd_prompt || '无';

      resultEl.style.display = 'block';

    } catch (err) {
      errorEl.textContent = '❌ ' + err.message;
      errorEl.style.display = 'block';
    } finally {
      loading.style.display = 'none';
    }
  }

  document.getElementById('videoIdInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') submitQuery();
  });
</script>

<!-- ========== 新增：仅预览（不下载）的本地文件支持 ========== -->

<!-- 预览模态框 -->
<div id="previewModal" style="
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
">
  <span onclick="closePreview()"
        style="
          position: absolute;
          top: 15px;
          right: 30px;
          color: white;
          font-size: 32px;
          cursor: pointer;
        ">&times;</span>
  <div style="
    background: white;
    margin: 2% auto;
    width: 90%;
    height: 90%;
    max-width: 1200px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  ">
    <iframe id="previewFrame" style="width:100%; height:100%; border:none; display:none;"></iframe>
    <pre id="previewText" style="
      padding: 20px;
      height: 100%;
      overflow: auto;
      background: #f8f9fa;
      font-family: Consolas, monospace;
      font-size: 14px;
      margin: 0;
      display: none;
    "></pre>
    <div id="previewPlaceholder" style="
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 18px;
    ">该类型文件无法在浏览器中预览</div>
  </div>
</div>

<script>
  // 本地文件路径（必须与 HTML 同目录）
  const LOCAL_FILES = {
    ppt: 'presentation.pptx',     // 浏览器无法预览 .pptx
    doc: 'report.pdf',            // 浏览器可原生预览 PDF
    dataset: 'final_summary.jsonl' // 纯文本，可读取显示
  };

  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.btn-group .btn');
    if (buttons[0]) buttons[0].addEventListener('click', () => openPreview('ppt'));
    if (buttons[1]) buttons[1].addEventListener('click', () => openPreview('doc'));
    if (buttons[2]) buttons[2].addEventListener('click', () => openPreview('dataset'));
  });

  function openPreview(type) {
    const filename = LOCAL_FILES[type];
    if (!filename) {
      alert('文件路径未配置');
      return;
    }

    const frame = document.getElementById('previewFrame');
    const text = document.getElementById('previewText');
    const placeholder = document.getElementById('previewPlaceholder');

    // 先隐藏所有内容
    frame.style.display = 'none';
    text.style.display = 'none';
    placeholder.style.display = 'none';

    if (type === 'doc') {
      // PDF：使用 iframe 预览（需通过 http://localhost 访问）
      frame.src = filename;
      frame.style.display = 'block';
      document.getElementById('previewModal').style.display = 'block';
    } else if (type === 'dataset') {
      // 文本文件：fetch 并显示
      fetch(filename)
        .then(res => {
          if (!res.ok) throw new Error('文件未找到');
          return res.text();
        })
        .then(content => {
          text.textContent = content;
          text.style.display = 'block';
          document.getElementById('previewModal').style.display = 'block';
        })
        .catch(err => {
          alert('❌ 无法加载数据集：' + err.message);
        });
    } else if (type === 'ppt') {
      // PPT：无法预览，显示提示
      placeholder.textContent = 'PowerPoint 文件无法在浏览器中预览，请使用本地软件打开。';
      placeholder.style.display = 'flex';
      document.getElementById('previewModal').style.display = 'block';
    }
  }

  function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
    document.getElementById('previewFrame').src = '';
  }

  document.getElementById('previewModal').onclick = function(e) {
    if (e.target === this) closePreview();
  };
</script>

</body>
</html>