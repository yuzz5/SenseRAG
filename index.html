<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤šæ¨¡æ€è§†é¢‘é—®ç­”ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.7;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #1a66c3;
      font-size: 1.8em;
      margin-bottom: 10px;
    }

    .btn-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #1a66c3;
      color: white;
    }

    .btn-secondary {
      background-color: #e0e7ed;
      color: #1a66c3;
    }

    .search-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin: 20px 0;
      text-align: center;
    }

    .search-box h2 {
      color: #1a66c3;
      margin-top: 0;
      font-size: 1.4em;
    }

    .search-input {
      width: 80%;
      padding: 12px;
      border: 1px solid #d1dbe5;
      border-radius: 6px;
      font-size: 16px;
      margin: 10px 0;
      box-sizing: border-box;
    }

    .search-btn {
      background-color: #1a66c3;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-btn:hover {
      background-color: #134b8e;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin: 20px 0;
    }

    .section h2 {
      color: #1a66c3;
      margin-top: 0;
      padding-left: 10px;
      position: relative;
      border-left: 4px solid #1a66c3;
      font-size: 1.3em;
    }

    .result {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-top: 20px;
      display: none;
    }

    .loading {
      text-align: center;
      color: #1a66c3;
      display: none;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .images img {
      height: 120px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .answer {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #eee;
    }

    .sd-prompt {
      background-color: #f0f7ff;
      padding: 12px;
      border-left: 4px solid #1a66c3;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>SenseRAG: å¤šæ¨¡æ€æ„ŸçŸ¥ä¸ç”Ÿæˆå¼åœºæ™¯ç†è§£é¢„æµ‹ç³»ç»Ÿ</h1>

  <div class="btn-group">
    <button class="btn btn-primary">PPT</button>
    <button class="btn btn-secondary">ğŸ“„ æ–‡æ¡£</button>
    <button class="btn btn-secondary">ğŸ“Š æ•°æ®é›†</button>
  </div>

  <div class="search-box">
    <h2>å¤šæ¨¡æ€è§†é¢‘é—®ç­”</h2>
    <p style="color: #666; text-align: center;">ä¾‹å¦‚ï¼šâ€œè¯·å¸®æˆ‘é¢„æµ‹å‡ºè§†é¢‘IDä¸ºPBjKI8lrRws_1507çš„åœºæ™¯â€</p>
    <input type="text" id="videoIdInput" class="search-input"
           placeholder="è¯·è¾“å…¥åŒ…å«è§†é¢‘IDçš„å¥å­ï¼Œå¦‚ï¼šè§†é¢‘IDæ˜¯PBjKI8lrRws_1507" />
    <button class="search-btn" onclick="submitQuery()">ğŸ” æäº¤æŸ¥è¯¢</button>
  </div>

  <!-- æŸ¥è¯¢ç»“æœåŒºåŸŸï¼ˆç´§æ¥åœ¨æœç´¢æ¡†ä¸‹æ–¹ï¼‰ -->
  <div class="result" id="result">
    <h2>è§†é¢‘ ID: <span id="resVideoId"></span> ï¼ˆæ ‡ç­¾ï¼š<span id="resLabel"></span>ï¼‰</h2>
    <div class="images" id="originalFrameDiv"></div>
    <div class="images" id="sdImagesDiv"></div>
    <div id="answers"></div>
    <h3>Stable Diffusion Prompt</h3>
    <div class="sd-prompt" id="sdPrompt"></div>
  </div>

  <div class="loading" id="loading">æ­£åœ¨åŠ è½½...</div>
  <div class="error" id="error"></div>

  <!-- é¡¹ç›®ä»‹ç»éƒ¨åˆ†ï¼ˆä¿æŒåœ¨ç»“æœä¸‹æ–¹ï¼‰ -->
  <div class="section">
    <h2>ä¸€ã€é¡¹ç›®æ–¹å‘ä¸æ ¸å¿ƒç›®æ ‡</h2>
    <p>SenseRAGæ—¨åœ¨æ„å»ºä¸€ä¸ªèåˆè§†å¬æ„ŸçŸ¥ã€æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ã€å¤§è¯­è¨€æ¨¡å‹ä¸æ‰©æ•£ç”Ÿæˆæ¨¡å‹çš„åœºæ™¯ç†è§£é¢„æµ‹ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿé€šè¿‡è§†å¬é—®ç­”ï¼ˆAVQAï¼‰æ¡†æ¶ï¼Œå°†å¤šæ¨¡æ€æ„ŸçŸ¥ä¸è‡ªç„¶è¯­è¨€æ¨ç†æ·±åº¦ç»“åˆï¼Œå®ç°ä»æ„ŸçŸ¥åˆ°é¢„æµ‹å¯è§†åŒ–çš„å®Œæ•´é—­ç¯ã€‚</p>
    <p>åœ¨ç ”ç©¶å±‚é¢ï¼Œç³»ç»Ÿå°†é‡ç‚¹çªç ´ä»¥ä¸‹æ–¹å‘ï¼šå»ºç«‹è§†å¬ä¿¡å·çš„é«˜æ•ˆå¯¹é½ä¸è¯­ä¹‰ç¼–ç æœºåˆ¶ï¼›å¼•å…¥æ£€ç´¢å¢å¼ºç­–ç•¥æå‡æ¨ç†èƒ½åŠ›ï¼›ç ”å‘äº‹æ•…é¢„æµ‹ä¸åæœæ¨æ¼”æœºåˆ¶ï¼›åˆ©ç”¨Stable Diffusionç­‰æ‰©æ•£æ¨¡å‹å®ç°é¢„æµ‹ç»“æœçš„å¯è§†åŒ–å‘ˆç°ã€‚</p>
    <p>åœ¨é¢„æœŸæˆæœæ–¹é¢ï¼ŒSenseRAGå°†åœ¨ä¸‰ä¸ªå±‚é¢åˆ›é€ ä»·å€¼ï¼šç§‘å­¦å±‚é¢æ¨åŠ¨AVQAä¸å¤šæ¨¡æ€RAGæŠ€æœ¯çš„å‘å±•ï¼Œæ¢ç´¢"æ„ŸçŸ¥-æ£€ç´¢-ç”Ÿæˆ"ä¸€ä½“åŒ–èŒƒå¼ï¼›æŠ€æœ¯å±‚é¢ä»¥å›½é™…åŸºå‡†ï¼ˆå¦‚AVQAæ•°æ®é›†ã€nuScenes/Argoverseï¼‰ä¸ºè¯„æµ‹å¹³å°ï¼Œç¡®ä¿åœ¨å¤šæ¨¡æ€é—®ç­”å‡†ç¡®ç‡ã€é¢„æµ‹ç²¾åº¦ç­‰æŒ‡æ ‡ä¸Šè¾¾åˆ°å…ˆè¿›æ°´å¹³ï¼›ç¤¾ä¼šå±‚é¢ç›´æ¥å¯¹æ¥ã€Šäººå·¥æ™ºèƒ½+è¡ŒåŠ¨æ„è§ã€‹ã€ã€Šæ•°å­—ä¸­å›½å»ºè®¾2025å¹´è¡ŒåŠ¨æ–¹æ¡ˆã€‹ç­‰å›½å®¶æˆ˜ç•¥éœ€æ±‚ã€‚</p>
    <p>SenseRAGçš„ç ”å‘ä¸ä»…æ˜¯å¯¹äººå·¥æ™ºèƒ½å‰æ²¿çš„æ¢ç´¢ï¼Œæ›´æ˜¯è½å®å›½å®¶æˆ˜ç•¥çš„å…·ä½“å®è·µï¼Œä¸ºæ¨åŠ¨äººå·¥æ™ºèƒ½å®ç°å®‰å…¨å¯æ§ã€è§£é‡Šé€æ˜æä¾›äº†æ–°çš„æŠ€æœ¯è·¯å¾„ã€‚</p>
  </div>

  <div class="section">
    <h2>äºŒã€åŸç†ç®€ä»‹</h2>
    <p>æœ¬ç³»ç»Ÿé€šè¿‡ä¸€ä¸ªè¿è´¯çš„æµç¨‹å®ç°è§†é¢‘ç†è§£ä¸é¢„æµ‹ã€‚é¦–å…ˆï¼Œåœ¨æ•°æ®å‡†å¤‡é˜¶æ®µï¼Œç³»ç»Ÿåˆ©ç”¨Vggishå’ŒVGG-19åˆ†åˆ«å¤„ç†éŸ³é¢‘ä¸è§†é¢‘å¸§ï¼Œå¹¶å€ŸåŠ©CLIPæ¨¡å‹å°†æ–‡æœ¬æ ‡ç­¾ä¸è§†é¢‘å¸§ç»Ÿä¸€ç¼–ç ä¸º512ç»´å‘é‡ï¼Œå­˜å…¥å‘é‡æ•°æ®åº“ä»¥æ„å»ºä¸€ä¸ªå¤šæ¨¡æ€ä¿¡æ¯åº“ã€‚</p>
    <p>å½“ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿä¼šå¯¹æŸ¥è¯¢è¿›è¡Œåˆ†è§£ï¼Œå¹¶å°†å…¶ç¼–ç ä¸ºå‘é‡ç”¨äºæ£€ç´¢ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹æ–‡æœ¬ä½œä¸ºä¸Šä¸‹æ–‡ã€‚éšåï¼Œè¯¥å‘é‡åœ¨æ•°æ®åº“ä¸­è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œæ‰¾å‡ºæœ€ç›¸å…³çš„å…³é”®è§†é¢‘å¸§ï¼Œå¹¶å°†å…¶ä¸åŸå§‹é—®é¢˜ä¸€åŒæäº¤ç»™å¤§å‹è¯­è¨€æ¨¡å‹ã€‚MLLMç»¼åˆè¿™äº›ä¿¡æ¯åï¼Œç”ŸæˆåŒ…å«æ–‡æœ¬ç­”æ¡ˆã€æ—¶é—´æˆ³å’Œè¯æ®å¸§çš„å›åº”ã€‚</p>
    <p>å¯¹äºé¢„æµ‹æ€§ä»»åŠ¡ï¼Œç³»ç»Ÿä¼šæ£€ç´¢åŸè§†é¢‘çš„æœ€åä¸€å¸§ï¼Œå¹¶å°†MLLMç”Ÿæˆçš„é¢„æµ‹ç­”æ¡ˆä½œä¸ºæç¤ºè¯ï¼Œå…±åŒè¾“å…¥è‡³Stable Diffusionæ¨¡å‹ã€‚æœ€ç»ˆï¼Œæ¨¡å‹åŸºäºè¿™äº›æ¡ä»¶åˆæˆç¬¦åˆé€»è¾‘çš„é¢„æµ‹å›¾åƒï¼Œä»è€Œå®Œæˆä»ç†è§£ç°çŠ¶åˆ°ç”Ÿæˆæœªæ¥çš„è·¨è¶Šã€‚</p>
  </div>
</div>

<script>
  // ä»è‡ªç„¶è¯­è¨€ä¸­æå– video_id çš„å‡½æ•°
  function extractVideoId(input) {
    // åŒ¹é…æ ¼å¼ï¼šå­—æ¯æ•°å­—ç»„åˆ + _ + æ•°å­—ï¼Œå¦‚ PBjKI8lrRws_1507
    const match = input.match(/[A-Za-z0-9]+_[0-9]+/);
    return match ? match[0] : null;
  }

  async function submitQuery() {
    const rawInput = document.getElementById('videoIdInput').value.trim();
    if (!rawInput) {
      alert('è¯·è¾“å…¥åŒ…å«è§†é¢‘IDçš„å¥å­');
      return;
    }

    // âœ… å…³é”®ï¼šä»å¥å­ä¸­æå– video_id
    const videoId = extractVideoId(rawInput);
    if (!videoId) {
      document.getElementById('error').textContent = 'âŒ æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„è§†é¢‘IDï¼ˆæ ¼å¼å¦‚ï¼šPBjKI8lrRws_1507ï¼‰';
      document.getElementById('error').style.display = 'block';
      return;
    }

    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    loading.style.display = 'block';
    errorEl.style.display = 'none';
    resultEl.style.display = 'none';

    try {
      const res = await fetch(`/api/result?video_id=${encodeURIComponent(videoId)}`);
      const data = await res.json();

      if (res.status !== 200) {
        throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');
      }

      document.getElementById('resVideoId').textContent = data.video_id;
      document.getElementById('resLabel').textContent = data.label;

      const origDiv = document.getElementById('originalFrameDiv');
      origDiv.innerHTML = data.original_frame_url ?
        `<strong>åŸå§‹æœ€åä¸€å¸§ï¼š</strong><br><img src="${data.original_frame_url}" alt="original frame">` : '';

      const sdImagesDiv = document.getElementById('sdImagesDiv');
      if (data.sd_image_urls && data.sd_image_urls.length > 0) {
        let sdImagesHtml = '<strong>Stable Diffusion ç”Ÿæˆå›¾åƒï¼š</strong><br>';
        data.sd_image_urls.forEach(url => {
          sdImagesHtml += `<img src="${url}" alt="SD image" style="height:120px; margin:5px; border:1px solid #ddd; border-radius:4px;">`;
        });
        sdImagesDiv.innerHTML = sdImagesHtml;
      } else {
        sdImagesDiv.innerHTML = '<strong>æœªæ‰¾åˆ°ç”Ÿæˆå›¾åƒ</strong>';
      }

      const answersDiv = document.getElementById('answers');
      answersDiv.innerHTML = '';
      data.answers.forEach(a => {
        const div = document.createElement('div');
        div.className = 'answer';
        div.innerHTML = `<strong>${a.question}</strong><br>${a.answer}`;
        answersDiv.appendChild(div);
      });

      document.getElementById('sdPrompt').textContent = data.sd_prompt || 'æ— ';

      resultEl.style.display = 'block';

    } catch (err) {
      errorEl.textContent = 'âŒ ' + err.message;
      errorEl.style.display = 'block';
    } finally {
      loading.style.display = 'none';
    }
  }

  document.getElementById('videoIdInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') submitQuery();
  });
</script>

<!-- ========== æ–°å¢ï¼šä»…é¢„è§ˆï¼ˆä¸ä¸‹è½½ï¼‰çš„æœ¬åœ°æ–‡ä»¶æ”¯æŒ ========== -->

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="previewModal" style="
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
">
  <span onclick="closePreview()"
        style="
          position: absolute;
          top: 15px;
          right: 30px;
          color: white;
          font-size: 32px;
          cursor: pointer;
        ">&times;</span>
  <div style="
    background: white;
    margin: 2% auto;
    width: 90%;
    height: 90%;
    max-width: 1200px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  ">
    <iframe id="previewFrame" style="width:100%; height:100%; border:none; display:none;"></iframe>
    <pre id="previewText" style="
      padding: 20px;
      height: 100%;
      overflow: auto;
      background: #f8f9fa;
      font-family: Consolas, monospace;
      font-size: 14px;
      margin: 0;
      display: none;
    "></pre>
    <div id="previewPlaceholder" style="
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 18px;
    ">è¯¥ç±»å‹æ–‡ä»¶æ— æ³•åœ¨æµè§ˆå™¨ä¸­é¢„è§ˆ</div>
  </div>
</div>

<script>
  // æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼ˆå¿…é¡»ä¸ HTML åŒç›®å½•ï¼‰
  const LOCAL_FILES = {
    ppt: 'presentation.pptx',     // æµè§ˆå™¨æ— æ³•é¢„è§ˆ .pptx
    doc: 'report.pdf',            // æµè§ˆå™¨å¯åŸç”Ÿé¢„è§ˆ PDF
    dataset: 'final_summary.jsonl' // çº¯æ–‡æœ¬ï¼Œå¯è¯»å–æ˜¾ç¤º
  };

  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.btn-group .btn');
    if (buttons[0]) buttons[0].addEventListener('click', () => openPreview('ppt'));
    if (buttons[1]) buttons[1].addEventListener('click', () => openPreview('doc'));
    if (buttons[2]) buttons[2].addEventListener('click', () => openPreview('dataset'));
  });

  function openPreview(type) {
    const filename = LOCAL_FILES[type];
    if (!filename) {
      alert('æ–‡ä»¶è·¯å¾„æœªé…ç½®');
      return;
    }

    const frame = document.getElementById('previewFrame');
    const text = document.getElementById('previewText');
    const placeholder = document.getElementById('previewPlaceholder');

    // å…ˆéšè—æ‰€æœ‰å†…å®¹
    frame.style.display = 'none';
    text.style.display = 'none';
    placeholder.style.display = 'none';

    if (type === 'doc') {
      // PDFï¼šä½¿ç”¨ iframe é¢„è§ˆï¼ˆéœ€é€šè¿‡ http://localhost è®¿é—®ï¼‰
      frame.src = filename;
      frame.style.display = 'block';
      document.getElementById('previewModal').style.display = 'block';
    } else if (type === 'dataset') {
      // æ–‡æœ¬æ–‡ä»¶ï¼šfetch å¹¶æ˜¾ç¤º
      fetch(filename)
        .then(res => {
          if (!res.ok) throw new Error('æ–‡ä»¶æœªæ‰¾åˆ°');
          return res.text();
        })
        .then(content => {
          text.textContent = content;
          text.style.display = 'block';
          document.getElementById('previewModal').style.display = 'block';
        })
        .catch(err => {
          alert('âŒ æ— æ³•åŠ è½½æ•°æ®é›†ï¼š' + err.message);
        });
    } else if (type === 'ppt') {
      // PPTï¼šæ— æ³•é¢„è§ˆï¼Œæ˜¾ç¤ºæç¤º
      placeholder.textContent = 'PowerPoint æ–‡ä»¶æ— æ³•åœ¨æµè§ˆå™¨ä¸­é¢„è§ˆï¼Œè¯·ä½¿ç”¨æœ¬åœ°è½¯ä»¶æ‰“å¼€ã€‚';
      placeholder.style.display = 'flex';
      document.getElementById('previewModal').style.display = 'block';
    }
  }

  function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
    document.getElementById('previewFrame').src = '';
  }

  document.getElementById('previewModal').onclick = function(e) {
    if (e.target === this) closePreview();
  };
</script>

</body>
</html>